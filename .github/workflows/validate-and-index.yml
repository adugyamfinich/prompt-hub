name: Validate and Update Index

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'prompts/**/*.md'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'prompts/**/*.md'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  validate:
    name: Validate Prompts
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Add any dependencies here if needed
    
    - name: Validate all prompts
      run: |
        python scripts/validate_prompt.py prompts/
    
    - name: Comment validation results on PR
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âŒ Prompt validation failed. Please check the workflow logs and fix the issues.'
          })

  generate-index:
    name: Generate Index
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Generate index
      run: |
        python scripts/generate_index.py
    
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet INDEX.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push if changed
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add INDEX.md
        git commit -m "Auto-update index [skip ci]"
        git push

  label-pr:
    name: Label Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Detect changes and add labels
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.issue.number;
          
          // Get changed files
          const { data: files } = await github.rest.pulls.listFiles({
            owner,
            repo,
            pull_number: pr_number
          });
          
          const labels = [];
          
          // Check what was changed
          const hasNewPrompt = files.some(f => 
            f.filename.startsWith('prompts/') && 
            f.status === 'added'
          );
          
          const hasPromptUpdate = files.some(f => 
            f.filename.startsWith('prompts/') && 
            (f.status === 'modified' || f.status === 'removed')
          );
          
          const hasDocsChange = files.some(f => 
            f.filename.includes('README') || 
            f.filename.includes('CONTRIBUTING') ||
            f.filename.startsWith('docs/')
          );
          
          const hasScriptChange = files.some(f => 
            f.filename.startsWith('scripts/')
          );
          
          // Determine category from path
          const categoryFiles = files.filter(f => f.filename.startsWith('prompts/by-category/'));
          if (categoryFiles.length > 0) {
            const categories = new Set(
              categoryFiles.map(f => {
                const match = f.filename.match(/prompts\/by-category\/([^/]+)/);
                return match ? match[1] : null;
              }).filter(Boolean)
            );
            
            categories.forEach(cat => {
              labels.push(`category:${cat}`);
            });
          }
          
          // Add appropriate labels
          if (hasNewPrompt) labels.push('new-prompt');
          if (hasPromptUpdate) labels.push('prompt-update');
          if (hasDocsChange) labels.push('documentation');
          if (hasScriptChange) labels.push('infrastructure');
          
          // Add size label
          const additions = files.reduce((sum, f) => sum + f.additions, 0);
          if (additions < 50) labels.push('size:small');
          else if (additions < 200) labels.push('size:medium');
          else labels.push('size:large');
          
          // Apply labels
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: labels
            });
          }
